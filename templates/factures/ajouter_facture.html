{% extends "base.html" %}
{% load static %}
{% block title %}Nouvelle facture / proforma{% endblock %}

{% block content %}
<h2 class="mb-4">üßæ Nouvelle facture / proforma</h2>

<form method="post" novalidate>
  {% csrf_token %}

  {# --- Erreurs globales --- #}
  {% if facture_form.non_field_errors %}
    <div class="alert alert-danger">{{ facture_form.non_field_errors }}</div>
  {% endif %}

  <!-- Informations globales -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white fw-bold">Informations</div>
    <div class="card-body row g-3">
      <div class="col-md-3">
        {{ facture_form.type_document.label_tag }}
        {{ facture_form.type_document }}
        {% for e in facture_form.type_document.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
      </div>
      <div class="col-md-3">
        {{ facture_form.client.label_tag }}
        {{ facture_form.client }}
        {% for e in facture_form.client.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
      </div>
      <div class="col-md-3">
        {{ facture_form.statut.label_tag }}
        {{ facture_form.statut }}
        {% for e in facture_form.statut.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
      </div>
      <div class="col-md-3">
        {{ facture_form.tva.label_tag }}
        {{ facture_form.tva }}
        {% for e in facture_form.tva.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
      </div>
      <div class="col-md-6">
        {{ facture_form.objet.label_tag }}
        {{ facture_form.objet }}
        {% for e in facture_form.objet.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
      </div>
      <div class="col-md-3">
        {{ facture_form.remise_globale_type.label_tag }}
        {{ facture_form.remise_globale_type }}
        {% for e in facture_form.remise_globale_type.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
      </div>
      <div class="col-md-3">
        {{ facture_form.remise_globale_valeur.label_tag }}
        {{ facture_form.remise_globale_valeur }}
        {% for e in facture_form.remise_globale_valeur.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        <div class="form-text">Si ‚ÄúPourcentage‚Äù, saisir par ex. 10 pour 10 % ; si ‚ÄúMontant‚Äù, saisir le montant en FCFA.</div>
      </div>
      <div class="col-md-3">
        {{ facture_form.frais_livraison.label_tag }}
        {{ facture_form.frais_livraison }}
        {% for e in facture_form.frais_livraison.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
      </div>
    </div>
  </div>

  <!-- Lignes -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-secondary text-white fw-bold d-flex justify-content-between align-items-center">
      <span>Lignes de produits</span>
      <button type="button" class="btn btn-light btn-sm" id="add-line">‚ûï Ajouter une ligne</button>
    </div>

    <div class="card-body" id="ligne-container">
      {{ formset.management_form }}

      {% if formset.non_form_errors %}
        <div class="alert alert-danger">{{ formset.non_form_errors }}</div>
      {% endif %}

      <div class="row fw-bold text-muted mb-2">
        <div class="col-md-3">Produit</div>
        <div class="col-md-2 text-end">Quantit√©</div>
        <div class="col-md-2 text-end">PU (HT)</div>
        <div class="col-md-3">Remise (type / valeur)</div>
        <div class="col-md-1 text-end">Montant</div>
        <div class="col-md-1 text-end">Suppr.</div>
      </div>

      {% for form in formset %}
        <div class="ligne-form row g-2 align-items-end mb-2">
          <div class="col-md-3">
            {{ form.produit }}
            {% for e in form.produit.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
          </div>
          <div class="col-md-2">
            {{ form.quantite }}
            {% for e in form.quantite.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
          </div>
          <div class="col-md-2">
            {{ form.prix_unitaire }}
            {% for e in form.prix_unitaire.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
          </div>
          <div class="col-md-3 d-flex gap-2">
            <div class="flex-fill">{{ form.remise_type }}</div>
            <div class="flex-fill">{{ form.remise_valeur }}</div>
            {% for e in form.remise_type.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            {% for e in form.remise_valeur.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
          </div>
          <div class="col-md-1">
            <input type="text" class="form-control montant text-end" value="0,00" readonly>
          </div>
          <div class="col-md-1 text-end">
            {% if form.DELETE %}
              <span class="d-none delete-checkbox">{{ form.DELETE }}</span>
            {% endif %}
            <button type="button" class="btn btn-outline-danger btn-sm remove-line" title="Supprimer">üóëÔ∏è</button>
          </div>
        </div>
      {% endfor %}
    </div>

    <div class="border-top pt-3">
      <div class="row mb-2">
        <div class="col-md-8"></div>
        <div class="col-md-2 text-end"><strong>Sous-total (HT) :</strong></div>
        <div class="col-md-2 text-end"><span id="sous-total">0,00</span> FCFA</div>
      </div>

      <div class="row mb-2">
        <div class="col-md-8"></div>
        <div class="col-md-2 text-end"><strong>Remise globale :</strong></div>
        <div class="col-md-2 text-end"><span id="remise-globale">0,00</span> FCFA</div>
      </div>

      <div class="row mb-2">
        <div class="col-md-8"></div>
        <div class="col-md-2 text-end"><strong>Frais livraison :</strong></div>
        <div class="col-md-2 text-end"><span id="livraison">0,00</span> FCFA</div>
      </div>

      <div class="row mb-2">
        <div class="col-md-8"></div>
        <div class="col-md-2 text-end"><strong>Base HT :</strong></div>
        <div class="col-md-2 text-end"><span id="base-ht">0,00</span> FCFA</div>
      </div>

      <div class="row mb-2">
        <div class="col-md-8"></div>
        <div class="col-md-2 text-end"><strong>TVA :</strong></div>
        <div class="col-md-2 text-end"><span id="tva-montant">0,00</span> FCFA</div>
      </div>
    </div>
  </div>

  <div class="text-end mb-3">
    <h4><strong>Total TTC :</strong> <span id="total-ttc">0,00</span> <span class="badge bg-success">FCFA</span></h4>
  </div>

  <div class="d-flex justify-content-between">
    <a href="{% url 'factures:liste' %}" class="btn btn-outline-secondary">‚Üê Retour</a>
    <button type="submit" class="btn btn-success">üíæ Enregistrer</button>
  </div>
</form>

<!-- PRIX JSON pour autoprix -->
<script id="prix-json" type="application/json">
  {{ prix_json|safe }}
</script>

{% block scripts %}
<script>
  const PRIX_PRODUITS = JSON.parse(document.getElementById('prix-json').textContent);
  const nf = new Intl.NumberFormat('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
  const toNum = (v) => {
    if (v === null || v === undefined) return 0;
    const s = String(v).replace(/\s/g, '').replace(',', '.');
    const x = parseFloat(s);
    return isNaN(x) ? 0 : x;
  };

  function montantLigne(ligne) {
    const q = toNum(ligne.querySelector('.quantite-input')?.value || 0);
    const p = toNum(ligne.querySelector('.prix-input')?.value || 0);
    const t = ligne.querySelector('.remise-type')?.value || 'aucune';
    const rv = toNum(ligne.querySelector('.remise-valeur')?.value || 0);

    let brut = q * p;
    let rem = 0;
    if (t === 'pourcentage') rem = brut * (rv / 100);
    else if (t === 'montant') rem = Math.min(rv, brut);

    let net = Math.max(brut - rem, 0);
    return net;
  }

  function recalculer() {
    let sousTotal = 0;

    document.querySelectorAll('.ligne-form').forEach(ligne => {
      // ignorer les lignes marqu√©es DELETE
      const del = ligne.querySelector('.delete-checkbox input[type="checkbox"]');
      if (del && del.checked) {
        ligne.style.display = 'none';
        return;
      } else {
        ligne.style.display = '';
      }

      const m = montantLigne(ligne);
      const champMontant = ligne.querySelector('.montant');
      if (champMontant) champMontant.value = nf.format(m);
      sousTotal += m;
    });

    const tvaInput = document.getElementById('id_tva');
    const rgType = document.getElementById('id_remise_globale_type');
    const rgVal = toNum(document.getElementById('id_remise_globale_valeur')?.value || 0);
    const liv = toNum(document.getElementById('id_frais_livraison')?.value || 0);

    let rgg = 0;
    if (rgType && rgType.value === 'pourcentage') rgg = sousTotal * (rgVal / 100);
    else if (rgType && rgType.value === 'montant') rgg = Math.min(rgVal, sousTotal);

    const baseHT = Math.max(sousTotal - rgg + liv, 0);
    const tvaPct = toNum(tvaInput?.value || 0);
    const tvaMontant = baseHT * (tvaPct / 100);
    const ttc = baseHT + tvaMontant;

    document.getElementById('sous-total').textContent = nf.format(sousTotal);
    document.getElementById('remise-globale').textContent = nf.format(rgg);
    document.getElementById('livraison').textContent = nf.format(liv);
    document.getElementById('base-ht').textContent = nf.format(baseHT);
    document.getElementById('tva-montant').textContent = nf.format(tvaMontant);
    document.getElementById('total-ttc').textContent = nf.format(ttc);
  }

  // produit -> auto-prix
  document.addEventListener('change', function (e) {
    if (e.target.classList.contains('produit-select')) {
      const id = e.target.value;
      const prix = PRIX_PRODUITS[id];
      const ligne = e.target.closest('.ligne-form');
      const prixInput = ligne?.querySelector('.prix-input');
      if (prixInput && typeof prix !== 'undefined') {
        prixInput.value = parseFloat(prix).toFixed(2);
        recalculer();
      }
    }
    if (
      e.target.id === 'id_tva' || e.target.id === 'id_remise_globale_type' ||
      e.target.id === 'id_remise_globale_valeur' || e.target.id === 'id_frais_livraison' ||
      e.target.classList.contains('remise-type')
    ) {
      recalculer();
    }
  });

  // recalcul inputs
  document.addEventListener('input', function (e) {
    if (
      e.target.classList.contains('quantite-input') ||
      e.target.classList.contains('prix-input') ||
      e.target.classList.contains('remise-valeur') ||
      e.target.id === 'id_remise_globale_valeur' ||
      e.target.id === 'id_frais_livraison'
    ) {
      recalculer();
    }
  });

  // ajout de ligne
  document.getElementById('add-line').addEventListener('click', function () {
    const container = document.getElementById('ligne-container');
    const totalFormsInput = container.querySelector('[name$="-TOTAL_FORMS"]');
    const currentCount = parseInt(totalFormsInput.value);
    const first = container.querySelector('.ligne-form');
    if (!first) return;

    const clone = first.cloneNode(true);

    // r√©indexation
    clone.querySelectorAll('input, select, textarea, label').forEach(el => {
      if (el.tagName === 'LABEL' && el.getAttribute('for')) {
        el.setAttribute('for', el.getAttribute('for').replace(/-\d+-/, `-${currentCount}-`));
      }
      if (el.name) el.name = el.name.replace(/-\d+-/, `-${currentCount}-`);
      if (el.id)   el.id   = el.id.replace(/-\d+-/,   `-${currentCount}-`);
    });

    // reset valeurs
    const sp = clone.querySelector('.produit-select'); if (sp) sp.selectedIndex = 0;
    const q  = clone.querySelector('.quantite-input'); if (q)  q.value = '';
    const p  = clone.querySelector('.prix-input');     if (p)  p.value = '';
    const rt = clone.querySelector('.remise-type');    if (rt) rt.value = 'aucune';
    const rv = clone.querySelector('.remise-valeur');  if (rv) rv.value = '';
    const m  = clone.querySelector('.montant');        if (m)  m.value = '0,00';

    const del = clone.querySelector('.delete-checkbox input[type="checkbox"]');
    if (del) del.checked = false;

    container.appendChild(clone);
    totalFormsInput.value = currentCount + 1;
    recalculer();
  });

  // suppression
  document.addEventListener('click', function (e) {
    if (e.target.classList.contains('remove-line')) {
      const ligne = e.target.closest('.ligne-form');
      const del = ligne.querySelector('.delete-checkbox input[type="checkbox"]');
      if (del) {
        del.checked = true;
        ligne.style.display = 'none';
      } else {
        ligne.remove();
      }
      recalculer();
    }
  });

  document.addEventListener('DOMContentLoaded', recalculer);
</script>
{% endblock %}
{% endblock %}
